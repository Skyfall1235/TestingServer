<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wyatt Murray - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles from index.html for dark mode and Inter font */
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text color */
        }
        /* Custom scrollbar for a cleaner look in dark mode */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 10px;
        }

            ::-webkit-scrollbar-thumb:hover {
                background: #64748b;
            }

        /* Custom styles for the Skills Selector */
        .skill-tag {
            cursor: pointer;
            transition: all 0.2s;
        }

            .skill-tag:hover {
                opacity: 0.8;
            }

            .skill-tag.selected {
                background-color: #4c51bf; /* Indigo-600 */
                color: white;
                border-color: #4c51bf;
            }

            .skill-tag:not(.selected) {
                background-color: #2d3748; /* Gray-700 */
                color: #e2e8f0; /* Light text */
                border: 1px solid #4a5568; /* Gray-600 */
            }

        /* Accordion Panel Styling */
        .accordion-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            padding: 0 1rem; /* Padding needed for content to show */
        }

            /* Use JavaScript to set max-height to a large value when open */
            .accordion-panel.open {
                max-height: 2000px; /* Large enough height to cover content */
                padding-top: 1rem;
                padding-bottom: 2rem;
            }

        .accordion-header {
            cursor: pointer;
        }
    </style>
</head>
<body class="antialiased">

    <header class="bg-gray-800 shadow-sm py-4 sticky top-0 z-50 rounded-b-lg">
        <nav class="container mx-auto px-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-indigo-400 p-2">Admin Dashboard</h1>
            <a href="index.html" class="text-gray-300 hover:text-indigo-400 font-medium transition-colors rounded-md p-2 hover:bg-gray-700">View Portfolio</a>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto space-y-4">

            <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <label for="apiKey" class="block text-sm font-medium text-gray-300">API Key (Required for all operations)</label>
                <input type="password" id="apiKey" name="apiKey" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3" placeholder="Enter your secret API key">
            </div>

            <div class="bg-gray-900 rounded-xl shadow-2xl overflow-hidden">
                <div class="accordion-header flex justify-between items-center p-6 bg-gray-800 hover:bg-gray-700 transition-colors" data-accordion="projectFormPanel">
                    <h2 class="text-xl font-bold text-gray-100">Create New Project</h2>
                    <svg class="w-6 h-6 text-indigo-400 transform transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>

                <div id="projectFormPanel" class="accordion-panel bg-gray-900">
                    <form id="projectForm" class="space-y-6">

                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-300">Project Title</label>
                            <input type="text" id="title" name="title" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3" placeholder="e.g., Stellar VR Experience">
                        </div>

                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-300">Short Description</label>
                            <textarea id="description" name="description" rows="3" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3" placeholder="A brief, engaging summary for the project card."></textarea>
                        </div>

                        <div>
                            <label for="titleCardUrl" class="block text-sm font-medium text-gray-300">Title Card URL (Image URL)</label>
                            <input type="url" id="titleCardUrl" name="titleCardUrl" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3" placeholder="https://example.com/image.jpg">
                        </div>

                        <div>
                            <label for="projectOverview" class="block text-sm font-medium text-gray-300">Full Project Overview</label>
                            <textarea id="projectOverview" name="projectOverview" rows="6" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3" placeholder="Detailed explanation of the project, challenges, and solutions."></textarea>
                        </div>

                        <div>
                            <label for="growths" class="block text-sm font-medium text-gray-300">Learnings / Growths Section</label>
                            <textarea id="growths" name="growths" rows="4" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3" placeholder="What did you learn or improve while working on this project?"></textarea>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-200 mb-3">Skills Used</h3>
                            <div id="skillsContainer" class="flex flex-wrap gap-2 p-3 bg-gray-800 rounded-lg min-h-[40px]">
                                <p id="skillsLoading" class="text-gray-400">Loading skills...</p>
                            </div>
                        </div>

                        <div class="flex space-x-4">
                            <div class="flex-grow">
                                <label for="newSkillName" class="block text-sm font-medium text-gray-300">Add New Skill (If needed)</label>
                                <input type="text" id="newSkillName" placeholder="New Skill Name" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3">
                            </div>
                            <div>
                                <label for="newSkillImage" class="block text-sm font-medium text-gray-300">Image Source</label>
                                <input type="url" id="newSkillImage" placeholder="Image URL" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3">
                            </div>
                            <button type="button" id="addNewSkillBtn" class="mt-6 self-start bg-indigo-600 text-white px-4 py-2 rounded-md font-medium hover:bg-indigo-700 transition-colors shadow-lg">Add</button>
                        </div>

                        <div class="pt-4">
                            <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-full text-lg font-semibold hover:bg-indigo-700 transition-colors transform hover:scale-[1.01] shadow-xl">
                                Submit New Project
                            </button>
                        </div>

                        <div id="projectStatusMessage" class="mt-4 p-3 rounded-lg text-center font-medium hidden"></div>

                    </form>
                </div>
            </div>

            <div class="bg-gray-900 rounded-xl shadow-2xl overflow-hidden">
                <div class="accordion-header flex justify-between items-center p-6 bg-gray-800 hover:bg-gray-700 transition-colors" data-accordion="manageSkillsPanel">
                    <h2 class="text-xl font-bold text-gray-100">Manage Existing Skills</h2>
                    <svg class="w-6 h-6 text-indigo-400 transform transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>

                <div id="manageSkillsPanel" class="accordion-panel bg-gray-900">
                    <div class="space-y-4">
                        <p class="text-gray-300">This section is for managing (editing or deleting) skills that already exist in your API.</p>
                        <div class="p-4 bg-gray-800 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-200 mb-2">Current Skills List</h3>
                            <div id="currentSkillsList" class="flex flex-wrap gap-2 text-sm text-gray-400">
                                <p>Feature not fully implemented in this example.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <footer class="bg-gray-900 text-white py-8 mt-8 rounded-t-lg">
        <div class="container mx-auto px-4 text-center text-gray-400">
            <p>&copy; <span id="current-year-admin"></span> Wyatt Murray. Admin Panel.</p>
        </div>
    </footer>

    <script>
        const API_BASE_URL = 'https://localhost:7289';
        const SKILLS_API = `${API_BASE_URL}/skills`;
        const PROJECTS_API = `${API_BASE_URL}/projects`;

        let existingSkills = [];
        let selectedSkillNames = [];

        // Set current year in footer
        document.getElementById('current-year-admin').textContent = new Date().getFullYear();


// ACCORDION LOGIC
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', () => {
                const targetId = header.getAttribute('data-accordion');
                const targetPanel = document.getElementById(targetId);
                const icon = header.querySelector('svg');

                const isOpen = targetPanel.classList.contains('open');

                // Close all other panels
                document.querySelectorAll('.accordion-panel').forEach(panel => {
                    panel.classList.remove('open');
                    panel.previousElementSibling.querySelector('svg').style.transform = 'rotate(0deg)';
                });

                if (!isOpen) {
                    // Open the clicked panel
                    targetPanel.classList.add('open');
                    icon.style.transform = 'rotate(180deg)';
                }
            });
        });

// SKILLS LOGIC

        async function fetchAndRenderSkills() {
            const container = document.getElementById('skillsContainer');
            container.innerHTML = ''; // Clear initial content

            try {
                const response = await fetch(SKILLS_API);
                if (!response.ok) {
                    container.innerHTML = `<p class="text-red-400">Error loading skills: ${response.statusText}</p>`;
                    return;
                }
                existingSkills = await response.json();

                if (existingSkills.length === 0) {
                    container.innerHTML = '<p class="text-gray-400">No skills found. Add a new one below.</p>';
                    return;
                }

                existingSkills.forEach(skill => {
                    const skillName = skill.name;
                    const skillTag = document.createElement('span');
                    skillTag.textContent = skillName;
                    skillTag.dataset.skillName = skillName;
                    skillTag.className = 'skill-tag inline-block px-3 py-1 text-sm font-medium rounded-full border cursor-pointer';

                    // Check if skill is already selected and apply the class
                    if (selectedSkillNames.includes(skillName)) {
                        skillTag.classList.add('selected');
                    }

                    skillTag.addEventListener('click', () => toggleSkillSelection(skillTag, skillName));
                    container.appendChild(skillTag);
                });

            } catch (error) {
                container.innerHTML = `<p class="text-red-400">Network error fetching skills: ${error.message}</p>`;
            }
        }

        function toggleSkillSelection(tag, skillName) {
            const index = selectedSkillNames.indexOf(skillName);

            if (index > -1) {
                selectedSkillNames.splice(index, 1);
                tag.classList.remove('selected');
            } else {
                selectedSkillNames.push(skillName);
                tag.classList.add('selected');
            }
        }

        document.getElementById('addNewSkillBtn').addEventListener('click', async () => {
            const nameInput = document.getElementById('newSkillName');
            const imageInput = document.getElementById('newSkillImage');
            const skillName = nameInput.value.trim();
            const imageSource = imageInput.value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!skillName || !apiKey) {
                alert("Skill Name and API Key are required.");
                return;
            }

            if (existingSkills.some(s => s.name.toLowerCase() === skillName.toLowerCase())) {
                alert(`Skill "${skillName}" already exists.`);
                nameInput.value = '';
                imageInput.value = '';
                return;
            }

            const newSkillData = {
                name: skillName,
                imagesource: imageSource || 'default-image-url.png',
                skillCategory: 0
            };

            try {
                const response = await fetch(SKILLS_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey
                    },
                    body: JSON.stringify(newSkillData)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    alert(`Failed to create new skill: ${response.status} - ${errorBody}`);
                    return;
                }

                const createdSkill = await response.json();

                existingSkills.push(createdSkill);
                selectedSkillNames.push(createdSkill.name);

                await fetchAndRenderSkills();

                const newTag = document.querySelector(`[data-skill-name="${createdSkill.name}"]`);
                if (newTag) newTag.classList.add('selected');

                nameInput.value = '';
                imageInput.value = '';
                alert(`Skill "${skillName}" added and selected.`);

            } catch (error) {
                alert(`Error during new skill creation: ${error.message}`);
            }
        });

// PROJECT FORM SUBMISSION LOGIC (Updated to use correct status element)

        document.getElementById('projectForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const statusMessage = document.getElementById('projectStatusMessage');
            statusMessage.textContent = 'Submitting project...';
            statusMessage.className = 'mt-4 p-3 rounded-lg text-center font-medium bg-indigo-900 text-indigo-200 block';

            const form = e.target;
            const formData = new FormData(form);
            const apiKey = document.getElementById('apiKey').value.trim(); // Get API Key from the single external field

            if (!apiKey) {
                statusMessage.textContent = 'Error: API Key is required.';
                statusMessage.className = 'mt-4 p-3 rounded-lg text-center font-medium bg-red-900 text-red-200 block';
                return;
            }

            const skillListForDTO = selectedSkillNames.map(name => {
                const skill = existingSkills.find(s => s.name === name);
                return {
                    name: skill.name,
                    imagesource: skill.imagesource,
                    skillCategory: skill.skillCategory
                };
            });

            const projectDTO = {
                title: formData.get('title'),
                description: formData.get('description'),
                titleCardURL: formData.get('titleCardUrl'),
                projectOverview: formData.get('projectOverview'),
                growths: formData.get('growths'),
                skillList: {
                    skills: skillListForDTO
                },
                githubUrl: '',
                learnMoreUrl: ''
            };

            try {
                const response = await fetch(PROJECTS_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey
                    },
                    body: JSON.stringify(projectDTO)
                });

                if (response.ok) {
                    statusMessage.textContent = '✅ Project submitted successfully!';
                    statusMessage.className = 'mt-4 p-3 rounded-lg text-center font-medium bg-green-900 text-green-200 block';

                    // Clear only the form fields, not the global API key input
                    form.reset();
                    selectedSkillNames = [];
                    await fetchAndRenderSkills();

                } else {
                    const errorBody = await response.text();
                    statusMessage.textContent = `❌ Submission failed: ${response.status} - ${errorBody}`;
                    statusMessage.className = 'mt-4 p-3 rounded-lg text-center font-medium bg-red-900 text-red-200 block';
                }

            } catch (error) {
                statusMessage.textContent = `❌ Network Error: ${error.message}`;
                statusMessage.className = 'mt-4 p-3 rounded-lg text-center font-medium bg-red-900 text-red-200 block';
            }
        });

        // Initialize on load
        document.addEventListener('DOMContentLoaded', fetchAndRenderSkills);
    </script>
</body>
</html>